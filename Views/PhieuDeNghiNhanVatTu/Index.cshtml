<!DOCTYPE html>
<html dir="ltr" lang="en">
@Html.Partial("layout/Header")

<body>
    @Html.Partial("layout/TopBar")
    @Html.Partial("layout/LeftBar")
    <style>
        #table-data tr th, #table-tong-hop tr th{
            background-color: #34b7eb;
            color: black;
            font-size: 16px;
            border: 1px solid #d7d7d7;
            padding: 0px 10px;
            text-align: center;
        }
        #table-data tr td,  #table-tong-hop tr td{
            color: black;
            border :1px solid #d7d7d7; 
            padding: 10px 0px;
        }
        #table-tong-hop tr th{
            background-color: #75aac1;
            color: black;
            font-size: 16px;
        }
        #table-tong-hop tr td{
            color: black;
            border: 1px solid #d7d7d7;
            padding: 10px 0px;
        }
        #table-tong-hop tr{
            border-left: 1px solid #cbcbcb;
        }
        
        #table-data .row-stt, #table-tong-hop .row-stt{
            text-align: center;
        }
        #table-data .row-ma-phieu, #table-tong-hop .row-ma-phieu{
            padding: 2.5px 10px;
        }
        #table-data .row-ten-bp, #table-tong-hop .row-ten-bp{
            text-align: center;
        }
        #table-data .row-dien-giai, #table-tong-hop .row-dien-giai{
            padding: 2.5px 10px;
        }
        #table-data .nguoi-yeu-cau, #table-tong-hop .nguoi-yeu-cau{
            text-align: center;
        }
        #table-data .row-status, #table-tong-hop .row-status{
            text-align: center;
        }
        .form-check-input:hover{
            cursor: pointer;
        }
        
    </style>
    <div class="page-wrapper">
        <!-- ============================================================== -->
        <!-- Bread crumb and right sidebar toggle -->
        <!-- ============================================================== -->
        @* <div class="page-breadcrumb">
            <div class="row">
                <div class="col-12 d-flex no-block align-items-center">
                    <h4 class="page-title">Tables</h4>
                    <div class="ms-auto text-end">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active" aria-current="page">
                                    Library
                                </li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </div> *@
        <div style="width: 100%; display: flex;" id="container-filter">
            <input oninput="search(this)" placeholder="Tìm kiếm theo mã phiếu, thời gian lập phiếu, tên bộ phận, diễn giải, người yêu cầu" type="search" id="search" class="form-control"/>
            <div class="filter" style="display: flex;">
                <button onclick="xoaFilter('status', this)" class="btn btn-info btn-filter" style="width: 130px; display: none;" id="show-status">CHƯA DUYỆT X</button>
                <button onclick="xoaFilter('time-phieu-from;time-phieu-to',this)" class="btn btn-info btn-filter" style="width: 200px; display: none;" id="show-time">24/11/2023 X</button>
                <button onclick="xoaFilter('filter-select',this)" class="btn btn-info btn-filter" style="width: 130px; display: none;" id="show-select"></button>
            </div>
            <button class="btn- btn-primary" style="width: 10%;" data-bs-toggle="modal" data-bs-target="#filter">BỘ LỌC</button>
        </div>
        <div style="overflow: scroll; display: flex;">
            <table class="table" id="table-data" data-show-columns="true" style="width:50%">
                <thead id="main-thead">
                    <th style="display:none" class="check-box-column" id="check-box-column"></th>
                    <th>STT</th>
                    <th style="min-width: 150px;">MÃ PHIẾU</th>
                    <th style="min-width: 250px;">TÊN BỘ PHẬN</th>
                    <th style="min-width: 250px;">DIỄN GIẢI</th>
                    <th style="min-width: 200px;">NGƯỜI YÊU CẦU</th>
                    <th id="th-trang-thai" style="display: none; min-width: 200px;">TRẠNG THÁI</th>
                </thead>
                <tbody style="overflow: scroll">
                    
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7">
                            <button id="btn-xem-them" style="width: 100%;" class="btn btn-primary" onclick="xemThem()">XEM THÊM</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <button id="btn-xac-nhan-phe-duyet" style="width: 100%;display:none" class="btn btn-primary" onclick="xacNhanPheDuyet()">XÁC NHẬN</button>
        @* <ul id="pagination" class="pagination"></ul> *@
    </div>
    <!-- Filter -->
    <div class="modal fade" id="filter" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="static`BackdropLabel">BỘ LỌC</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <table style="margin: 0 auto;" id="table-filter">
                <tbody>
                    <tr>
                        <td style="font-weight: bold;">THỜI GIAN: </td>
                        <td>
                            <label>TỪ:</label>
                            <input style="width: 100%;" type="date" id="time-phieu-from" class="form-control"/>
                        </td>
                        <td>
                            <label>ĐẾN:</label>
                            <input style="width: 100%;" type="date" id="time-phieu-to" class="form-control"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight: bold;">CHỌN: </td>
                        <td colspan="2">
                            <select style="width: 100%;" class="form-select" id="filter-select">
                                <option value="" disabled selected>---CHỌN---</option>
                                <option value="ĐÃ CHỌN">ĐÃ CHỌN</option>
                                <option value="CHƯA CHỌN">CHƯA CHỌN</option>
                            </select>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ĐÓNG</button>
            <button type="button" class="btn btn-primary" onclick="filter()">XÁC NHẬN</button>
        </div>
        </div>
    </div>
    </div>
    <!-- ============================================================== -->
    <!-- End Container fluid  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- footer -->
    <!-- ============================================================== -->
    
    @Html.Partial("layout/Footer")
    <script>
        //BO LOC
        //dung de search tai o search
        function search(param){
            let timeOut;
            clearTimeout(timeOut);
            timeOut = setTimeout(()=>{
                filter();
            },900);  
        }
        let filterVal = {time:"", status:"", search:"", select:""};
        // ham loc
        let listFilter = [];
        
        
        function filter(){
            let timeFrom = $("#time-phieu-from").val() ? $("#time-phieu-from").val().split("-").reverse().join("/") : null;
            let timeTo = $("#time-phieu-to").val() ? $("#time-phieu-to").val().split("-").reverse().join("/") : null;;
            let rows = $("#table-data tbody tr");
            
            filterVal.time = timeFrom||timeTo ? `${timeFrom}-${timeTo}`:null;
            filterVal.status = $("#status").val()||null;
            filterVal.search = $("#search").val()||null;
            filterVal.select = $("#filter-select").val()||null;
            for(let key of Object.keys(filterVal)){
                if(key!="search" && filterVal[key]){
                    let str = filterVal[key]+" "+"X";
                    $(`#show-${key}`).text(str);
                    $(`#show-${key}`).css("display","");
                }
            }
            
            for(let i=0; i<rows.length; i++){
                listFilter[i].Select = $($("#table-data tbody tr .row-check")[i]).is(":checked") 
            }

            let paramFilter = {
                Select: $("#filter-select").val()||null,
                Search: $("#search").val()?.trim(),
                TimeFrom: $("#time-phieu-from").val()||null,
                TimeTo: $("#time-phieu-to").val()||null,
                Status: filterVal.status,
                ListFilters: listFilter,
            }
            
            
            //loc
            $.ajax({
                url: host + "/api/phieu-nhan-vat-tu/filter",
                "headers": {
                    "Content-Type": "application/json"
                },
                method: "POST",
                data: JSON.stringify(paramFilter)
            })
            .done(res=>{
                let rows = $("#table-data tbody tr");
                let stt = $("#table-data tbody tr .row-stt")
                let x = 1;
                for(let i=0; i<rows.length; i++){
                    if(res.length==0){
                        $(rows[i]).css("display","none")
                    }else{
                        for(let j=0; j<res.length; j++){
                            let id = $(rows[i]).attr("id").split("-")[1];
                            if(res[j]["id"]==id){
                                $(rows[i]).css("display","");
                                $(stt[i]).text(x);
                                x++;
                                break;
                            }else if(j==res.length-1){
                                $(rows[i]).css("display","none")
                            }
                        }
                    }
                }
            })
            @* renderDataTheoFilter();
            resetStt(); *@
            $(`#filter .btn-close`).click();
        }
        
        function xoaFilter(value, element){
            filterVal[value] = "";
            $(element).css("display","none");
            //reset input loc
            let valueArr = value.split(";");
            for(let i=0; i<valueArr.length; i++){
                $(`#${valueArr[i]}`).val("");
            }
            filter();
            resetStt();
        }
        
        function resetStt(){
            let stt = $("#table-data tbody tr .row-stt");
            let rows = $("#table-data tbody tr");
            let t = 1;
            for(let i=0; i<rows.length; i++){
                if($(rows[i]).css("display")!="none"){
                    $(stt[i]).text(t);
                    t++;
                }
            }
        }
    </script>
    <script>
        {
        const urlParams = new URLSearchParams(window.location.search);
        const status = urlParams.get("status");
        //neu phieu da duyet thi hien bang tong hop 
        if(status=='false'){
            $("#table-data").css("width","50%");
            let tableTongHop = `
                <table class="table" id="table-tong-hop" data-show-columns="true" style="width: 50%;">
                    <thead>
                        <th style="display:none"></th>
                        <th>STT</th>
                        <th style="min-width: 150px;">MÃ PHIẾU</th>
                        <th style="min-width: 250px;">TÊN BỘ PHẬN</th>
                        <th style="min-width: 250px;">DIỄN GIẢI</th>
                        <th style="min-width: 200px;">NGƯỜI YÊU CẦU</th>
                        <th style="min-width: 200px;">TRẠNG THÁI</th>
                    </thead>
                    <tbody style="overflow: scroll">
                        
                    </tbody>
                </table>`
            $(tableTongHop).insertAfter("#table-data");
            $("#btn-xem-them").css("display","")
        }else if(status=='true'){
            $("#btn-xac-nhan-phe-duyet").css("display","")
            $("#check-box-column").css("display","");
            @* chinh sua css khi hien thi danh sach phieu chua duyet *@
             $("#table-data").css("width","100%");
             $("#table-data tr th").css("border","1px solid #d7d7d7");
             $("#table-data tr th").css("padding","0px 10px");
             $("#table-data tr th").css("text-align","center");
             $("#btn-xem-them").css("display","none");
        }

        if(localStorage.getItem("listData")!=null){
            localStorage.removeItem("listData");
        }
        
        function clickRow(index, param, table){
            if(status=='false'){
                let checkBox = $(`#${table} .check-box-export-${index}`);
                $(checkBox).click();
                if($(checkBox).is(":checked")){
                    $(param).css("background","#76b5c5");   
                }else{
                    $(param).css("background","none");   
                }
            }
        }
        if(status=='false'){
            $("#table-data").on("contextmenu", function(event) {
                event.preventDefault();
                tongHop(true);
            });
            $("#table-tong-hop").on("contextmenu", function(event) {
                event.preventDefault();
                tongHop(false);
            });
        };
        
        
        //dua cac phieu da chon vao danh sach tong hop hoac huy tong hop tai bang tong hop

        //TONG HOP========================================================================================================================================
        if(status=="true"){
            $("#table-data").on("contextmenu",(e)=>{
                e.preventDefault();
                xacNhanPheDuyet();
            })
        }

        function tongHop(isTongHop){
            let table1 = isTongHop ? 'table-data' : 'table-tong-hop';
            let table2  = isTongHop ? 'table-tong-hop' : 'table-data';
            let listCheckbox = $(`#${table1} .check-box-export`);
            let existTongHop = false;
            let message = "";
            if(isTongHop){
                message = 'Bạn muốn đưa toàn bộ phiếu đã chọn vào danh sách chuẩn bị tổng hợp hoặc hủy phê duyệt?'
            }else{
                message = 'Bạn muốn hủy hoặc tổng hợp toàn bộ phiếu đã chọn?'
            }
            for(let i=0; i<listCheckbox.length; i++){
                let rowClassSelected = $(listCheckbox[i]).parent().parent().attr("class").split(" ")[0];
                let trangThai = $(`#${table1} .${rowClassSelected} .trang-thai`).text().trim();
                if($(listCheckbox[i]).is(":checked")){
                    if(trangThai=="ĐÃ TỔNG HỢP"){
                        existTongHop = true;
                        message = "Tồn tại phiếu nhận vật tư đã được tổng hợp trong báo giá khác. Bạn vẫn muốn xác nhận ?"
                        break;
                    }
                }
            }
            Swal.fire({
                icon: existTongHop ? "warning" : "question",
                title: message,
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: isTongHop ? 'Xác nhận' : "Hủy tổng hợp",
                denyButtonText: isTongHop ? "Hủy phê duyệt" : "Tổng hợp",
                }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    let listMaPhieu = $(`#${table1} .ma-phieu`);
                    let listPhieuDatetime = $(`#${table1} .phieu-datetime`);
                    @* let listMaPhieuSelected = []; *@
                    let rowSelected = "";
                    for(let i=0; i<listCheckbox.length; i++){
                        if($(listCheckbox[i]).is(":checked")){
                           
                            let rowClassSelected = $(listCheckbox[i]).parent().parent().attr("class").split(" ")[0];
                            let maPhieu = $(`#${table1} .${rowClassSelected} .ma-phieu`).text().trim();
                            let phieuDateTime = $(`#${table1} .${rowClassSelected} .phieu-datetime`).text().trim();
                            let tenBp = $(`#${table1} .${rowClassSelected} .ten-bp`).text().trim();
                            let dienGiai = $(`#${table1} .${rowClassSelected} .show-more`).text().trim();
                            let tenNguoiDeNghi = $(`#${table1} .${rowClassSelected} .nguoi-de-nghi`).text().trim();
                            let dateDeNghi = $(`#${table1} .${rowClassSelected} .date-de-nghi`).text().trim();
                            let decodeYear = decodeDatetime(dateDeNghi);
                            let indexRowSelected = rowClassSelected;
                            let trangThai = $(`#${table1} .${rowClassSelected} .trang-thai`).text().trim();
                            
                            if(trangThai=="CHƯA TỔNG HỢP" && existTongHop==false) existTongHop = true;
                            //xoa row tai table da duyet
                            $(`#${table1} .${rowClassSelected}`).remove();

                            //them row vao table tong hop
                            let row = `
                            <tr onclick="clickRow('${indexRowSelected}', this, '${table2}')" class="${indexRowSelected}" id="rows-${i}">
                                <td class="decode-year" style="display:none">${decodeYear}</td>
                                <td style="display:none"><input class="check-box-export-${indexRowSelected} check-box-export" type="checkbox"/></td>
                                <td class="row-stt"></td>
                                <td class="row-ma-phieu">
                                    <a href="#" onclick="directChitiet('${maPhieu}', '${decodeYear}', '${tenNguoiDeNghi}', ${i}, this, '${convertDateTimeDB(dateDeNghi)}')">
                                        <span class="ma-phieu">${maPhieu}</span> <span class="phieu-datetime">${phieuDateTime}</span>
                                    </a>
                                </td>
                                <td class="ten-bp row-ten-bp">${tenBp}</td>
                                <td style="min-width: 105px" class="row-dien-giai">
                                    <span onclick="showMore('${indexRowSelected}', this, '${table2}')" class="show-brief-${indexRowSelected} show-brief">
                                        <a href="#">
                                            <span>${dienGiai.split("").slice(0, Math.floor(dienGiai.length/3)).join("")}</span>
                                            <span>...</span>
                                        </a>
                                    </span>
                                    <span>
                                        <a class="show-more-${indexRowSelected} show-more" style="display:none" onclick="showMoreOrDirect('${indexRowSelected}', this, '${maPhieu}', '${decodeYear}', '${tenNguoiDeNghi}','${dateDeNghi}', '${table2}')" href="#">
                                            ${dienGiai}
                                        </a>

                                        <div class="date-de-nghi" style="display:none">${dateDeNghi}</div>
                                    </span>
                                </td>
                                <td class="nguoi-de-nghi nguoi-yeu-cau">${tenNguoiDeNghi}</td>
                                <td class="trang-thai" style="text-align:center">
                                    <span style="color:${trangThai=="CHƯA TỔNG HỢP"?"green":"red"}">${trangThai}</span>
                                </td>
                            </tr>`;
                            rowSelected+=row;
                        }
                    }
                    if(rowSelected !== ""){
                        $(`#${table2} tbody`).append(rowSelected);
                        let rowStt = $(`#${table2} .row-stt`);
                        for(let i=0; i<rowStt.length; i++){
                            $(rowStt[i]).text(i+1);
                        }
                    }else{
                        Swal.fire({
                            icon: 'error',
                            title: 'Alert',
                            text: 'Chưa có phiếu nào được chọn!'
                        })
                    }
                    
                }else if(result.isDenied){
                    let listData = []
                    if(!isTongHop){
                        let listVatTu = $(`#table-tong-hop .check-box-export`);
                        if(listVatTu.length == 0 ){
                            Swal.fire({
                                icon: 'error',
                                title: 'Alert',
                                text: 'Không có phiếu nào để tổng hợp!'
                            })
                        }else{
                            let listId = {"listId":[], "listGuid":[]};
                            for(let i=0; i<listVatTu.length; i++){
                                let classRow = $($(listVatTu)[i]).parent().parent().attr("class").split(" ")[0];
                                let maPhieu = $(`#table-tong-hop .${classRow} .ma-phieu`).text().trim();
                                let codeYear = $(`#table-tong-hop .${classRow} .decode-year`).text().trim();
                                let id = classRow.split(" ")[0];
                                listId.listId.push({maPhieu, codeYear});
                                listId.listGuid.push(id)
                            }
                            localStorage.setItem("listPhieuTongHop", JSON.stringify(listId));
                            window.location.href = "/phieu-de-nghi/tong-hop"
                        }
                    }else{
                        xoaPhieuPheDuyet();
                    }
                }
            })
        }

        function showMore(index, param, table){
            $(param).css("display","none");
            $(`#${table} .show-more-${index}`).css("display","block");
        }

        function showMoreOrDirect(index, param, maPhieu, codeYear, nguoiDeNghi, dateDeNghi, table){
            let idRowSelected = $(param).parent().parent().parent().attr("id");
            let dienGiai = $(`#table-data #${idRowSelected} .row-dien-giai`).text().trim();
            let tenBp = $(`#table-data #${idRowSelected} .ten-bp`).text().trim();
            Swal.fire({
                title: 'Bạn muốn thu gọn hay chuyển hướng?',
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: 'Thu gọn',
                denyButtonText: `Chuyển hướng`,
                }).then((result) => {
                    if(result.isConfirmed){
                        $(param).css("display","none");
                        $(`#${table} .show-brief-${index}`).css("display","block");
                    }else if(result.isDenied){
                        let deNghiDate = convertDateTimeDB(dateDeNghi);
                        let obj = {
                            code: maPhieu,
                            codeYear: codeYear,
                            nguoiDeNghi: nguoiDeNghi,
                            tenBp:tenBp,
                            dienGiai: dienGiai,
                        }
                        localStorage.setItem("info", JSON.stringify(obj));
                        window.location.href = `phieu-de-nghi/chi-tiet?code=${maPhieu}&codeYear=${codeYear}&nguoiDeNghi=${nguoiDeNghi}&dateDeNghi=${deNghiDate}`;
                    }
                });
        }

        function directChitiet(code, codeYear, nguoiDeNghi, index, param, dateDeNghi){
            let idRowSelected = $(param).parent().parent().attr("id");
            let dienGiai = $(`#table-data #${idRowSelected} .row-dien-giai`).text().trim();
            let info = {
                dienGiai,
                tenBp: $($(".row-ten-bp")[index-1]).text(),
                code, 
                codeYear, 
                nguoiDeNghi,
            }
            localStorage.setItem("info",JSON.stringify(info));
            window.location.href = `phieu-de-nghi/chi-tiet?code=${code}&codeYear=${codeYear}&nguoiDeNghi=${nguoiDeNghi}&dateDeNghi=${dateDeNghi}`;
        }
        
        function xacNhanPheDuyet(){
            Swal.fire({
                title: "Bạn chắc chắn các phiếu được chọn đã được phê duyệt ?",
                showDenyButton: true,
                showCancelButton: true,
                confirmButtonText: "Xác nhận",
                denyButtonText: `Hủy`
            }).then((result) => {
                if (result.isConfirmed) {
                    callApiPheDuyet();
                } else if (result.isDenied) {
                    
                }
            });
        }
        
        function callApiPheDuyet(){
            let rowChecks = $("#table-data tbody .row-check");
            let listResult = [];
            for(let i=0; i<rowChecks.length; i++){
                if($(rowChecks[i]).is(":checked")){
                    listResult.push(listFilter[i]);
                };
            }
            
            if(listResult.length==0){
                Swal.fire({
                    title: "Cảnh báo",
                    text: "Không có phiếu nào được chọn",
                    icon: "warning"
                });
            }else{
                $.ajax({
                    url: host + "/api/phieu-nhan-vat-tu-da-duyet",
                    "headers": {
                        "Content-Type": "application/json"
                    },
                    method: "POST",
                    data: JSON.stringify(listResult)
                })
                .done(()=>{
                   Swal.fire({
                        position: "center",
                        icon: "success",
                        title: "Xác nhận phê duyệt thành công!",
                        showConfirmButton: false,
                        timer: 1500
                    })
                    .then(()=>{
                        location.reload();
                    })
                })
                .fail(err=>{
                    console.log(err);
                })
            }
        }
        
        function xoaPhieuPheDuyet(){
            let rows = $("#table-data tbody tr");
            let rowCheckBoxs = $("#table-data tbody tr .check-box-export");
            let obj = {listIdPhieuPheDuyet:[]};
            for(let i=0; i<rowCheckBoxs.length; i++){
                if($(rowCheckBoxs[i]).is(":checked")){
                    let id = $(rows[i]).data("id");
                    obj.listIdPhieuPheDuyet.push(id);
                }
            }
            $.ajax({
                url: host + "/api/phieu-nhan-vat-tu-da-duyet",
                "headers": {
                    "Content-Type": "application/json"
                },
                method: "DELETE",
                data: JSON.stringify(obj.listIdPhieuPheDuyet)
            })
            .done(()=>{
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: "Hủy phê duyệt thành công !",
                    showConfirmButton: false,
                    timer: 1500
                })
                .then(()=>{
                    location.reload();
                })
            })
            .fail(()=>{
                Swal.fire({
                    position: "center",
                    icon: "error",
                    title: "Tồn tại phiếu phê duyệt đã tổng hợp. Vui lòng chọn lại !",
                    showConfirmButton: false,
                    timer: 1500
                })
            })
        }
        //function xem them
        let page = 1;
        function xemThem(){
            page++;
            $.ajax({
                url: host+ `/api/phieu-nhan-vat-tu?isDeleted=${status}&page=${page}`,
                method: "GET"
            })
            .done(res=>{
                let rows = "";
                let listPhieuNVTDaDuyet = res.listPhieuNVTDaDuyet;
                let currentCountRow = $("#table-data tbody tr").length;
                let x = currentCountRow;
                for(let i=0; i<listPhieuNVTDaDuyet.length; i++){
                    let decodeYear = decodeDatetime(listPhieuNVTDaDuyet[i]["dateDeNghi"]);
                    let lengthDienGiai = listPhieuNVTDaDuyet[i]["dienGiai"].length;
                    let row = `
                    <tr onclick="clickRow('${listPhieuNVTDaDuyet[i]["id"]}', this, 'table-data')" class="${listPhieuNVTDaDuyet[i]["id"]}" id="rows-${i}" data-id="${listPhieuNVTDaDuyet[i]["id"]}">
                        <td style="display:none"><input class="check-box-export-${listPhieuNVTDaDuyet[i]["id"]} check-box-export" type="checkbox"/></td>
                        <td class=row-stt>${++x}</td>
                        <td class="row-ma-phieu">
                            <a href="#" onclick="directChitiet('${listPhieuNVTDaDuyet[i]["maPhieu"]}', '${decodeYear}', '${listPhieuNVTDaDuyet[i]["tenNguoiDeNghi"]}', ${x}, this, '${convertDateTimeDB(listPhieuNVTDaDuyet[i]["dateDeNghi"])}')">
                                <span class="ma-phieu">${listPhieuNVTDaDuyet[i]["maPhieu"]}</span> <span class="phieu-datetime">${convertDateTime(listPhieuNVTDaDuyet[i]["dateDeNghi"])}</span>
                            </a>
                        </td>
                        <td class="ten-bp row-ten-bp">${listPhieuNVTDaDuyet[i]["tenBoPhan"]}</td>
                        <td style="min-width: 105px" class="row-dien-giai">
                            <span onclick="showMore('${listPhieuNVTDaDuyet[i]["id"]}', this, 'table-data')" class="show-brief-${listPhieuNVTDaDuyet[i]["id"]} show-brief">
                                <a href="#">
                                    <span>${listPhieuNVTDaDuyet[i]["dienGiai"]?.split("").slice(0,Math.floor(lengthDienGiai/3)).join("")}</span>
                                    <span>...</span>
                                </a>
                            </span>
                            <span>
                                <a class="show-more-${listPhieuNVTDaDuyet[i]["id"]} show-more" style="display:none" onclick="showMoreOrDirect('${listPhieuNVTDaDuyet[i]["id"]}', this, '${listPhieuNVTDaDuyet[i]["maPhieu"]}', '${decodeYear}', '${listPhieuNVTDaDuyet[i]["tenNguoiDeNghi"]}','${listPhieuNVTDaDuyet[i]["dateDeNghi"]}','table-data', )" href="#">
                                    ${listPhieuNVTDaDuyet[i]["dienGiai"]}
                                </a>
                                <div class="date-de-nghi" style="display:none">${listPhieuNVTDaDuyet[i]["dateDeNghi"]}</div>
                            </span>
                        </td>
                        <td class="nguoi-de-nghi nguoi-yeu-cau">${listPhieuNVTDaDuyet[i]["tenNguoiDeNghi"]}</td>
                        <td class="trang-thai" style="text-align:center">
                            ${listPhieuNVTDaDuyet[i]["baoGiaId"]==null ? `<span style="color:green">CHƯA TỔNG HỢP</span>` : `<span style="color:RED">ĐÃ TỔNG HỢP</span>`}
                        </td>
                    </tr>`;
                    rows+=row;
                };
                $("#table-data tbody").append(rows);
            })
        }
        //INIT DATA =============================================================================================================================
        function initData(status, page){
            $.ajax({
                url: host+ `/api/phieu-nhan-vat-tu?isDeleted=${status}&page=${page}`,
                method: "GET"
            })
            .done(res=>{
                let listPhieuNVTFast = res.listPhieuNVTFast?res.listPhieuNVTFast.reverse():null;
                let listPhieuNVTDaDuyet = res.listPhieuNVTDaDuyet;
                function importTable(listPhieuNVTDaDuyet, listPhieuNVTFast){
                    let rows = "";
                    $("#table-data tbody").html("");
                    if(!listPhieuNVTFast){
                        //view da duyet
                        //thay doi kich co cua header tai cua bang #table-data
                        let headersTableData = $("#table-data thead th");
                        let listSize = ["","",150,250,250,150,150];
                        for(let i=0; i<headersTableData.length; i++){
                            $(headersTableData[i]).css("min-width",`${listSize[i]}px`);
                        }
                        $("#th-trang-thai").css("display","");
                        $("#container-filter").css("display","none")
                        for(let i=0; i<listPhieuNVTDaDuyet.length; i++){
                            let decodeYear = decodeDatetime(listPhieuNVTDaDuyet[i]["dateDeNghi"]);
                            let x = i;
                            let lengthDienGiai = listPhieuNVTDaDuyet[i]["dienGiai"].length;
                            let row = `
                            <tr onclick="clickRow('${listPhieuNVTDaDuyet[i]["id"]}', this, 'table-data')" class="${listPhieuNVTDaDuyet[i]["id"]}" id="rows-${i}" data-id="${listPhieuNVTDaDuyet[i]["id"]}">
                                <td style="display:none"><input class="check-box-export-${listPhieuNVTDaDuyet[i]["id"]} check-box-export" type="checkbox"/></td>
                                <td class=row-stt>${++x}</td>
                                <td class="row-ma-phieu">
                                    <a href="#" onclick="directChitiet('${listPhieuNVTDaDuyet[i]["maPhieu"]}', '${decodeYear}', '${listPhieuNVTDaDuyet[i]["tenNguoiDeNghi"]}', ${x}, this, '${convertDateTimeDB(listPhieuNVTDaDuyet[i]["dateDeNghi"])}')">
                                        <span class="ma-phieu">${listPhieuNVTDaDuyet[i]["maPhieu"]}</span> <span class="phieu-datetime">${convertDateTime(listPhieuNVTDaDuyet[i]["dateDeNghi"])}</span>
                                    </a>
                                </td>
                                <td class="ten-bp row-ten-bp">${listPhieuNVTDaDuyet[i]["tenBoPhan"]}</td>
                                <td style="min-width: 105px" class="row-dien-giai">
                                    <span onclick="showMore('${listPhieuNVTDaDuyet[i]["id"]}', this, 'table-data')" class="show-brief-${listPhieuNVTDaDuyet[i]["id"]} show-brief">
                                        <a href="#">
                                            <span>${listPhieuNVTDaDuyet[i]["dienGiai"]?.split("").slice(0,Math.floor(lengthDienGiai/3)).join("")}</span>
                                            <span>...</span>
                                        </a>
                                    </span>
                                    <span>
                                        <a class="show-more-${listPhieuNVTDaDuyet[i]["id"]} show-more" style="display:none" onclick="showMoreOrDirect('${listPhieuNVTDaDuyet[i]["id"]}', this, '${listPhieuNVTDaDuyet[i]["maPhieu"]}', '${decodeYear}', '${listPhieuNVTDaDuyet[i]["tenNguoiDeNghi"]}','${listPhieuNVTDaDuyet[i]["dateDeNghi"]}','table-data', )" href="#">
                                            ${listPhieuNVTDaDuyet[i]["dienGiai"]}
                                        </a>
                                        <div class="date-de-nghi" style="display:none">${listPhieuNVTDaDuyet[i]["dateDeNghi"]}</div>
                                    </span>
                                </td>
                                <td class="nguoi-de-nghi nguoi-yeu-cau">${listPhieuNVTDaDuyet[i]["tenNguoiDeNghi"]}</td>
                                <td class="trang-thai" style="text-align:center">
                                    ${listPhieuNVTDaDuyet[i]["baoGiaId"]==null ? `<span style="color:green">CHƯA TỔNG HỢP</span>` : `<span style="color:RED">ĐÃ TỔNG HỢP</span>`}
                                </td>
                            </tr>`;
                            rows+=row;
                        };
                    }else{
                        //view chua duyet
                        let x = 0;
                        $("#th-trang-thai").css("display","none");
                        for(let i=0; i<listPhieuNVTFast.length; i++){
                            if(listPhieuNVTDaDuyet.length > 0){
                                for(let j=0; j<listPhieuNVTDaDuyet.length; j++){
                                    if(listPhieuNVTFast[i]["stt_rec"]==listPhieuNVTDaDuyet[j]["maPhieu"]){
                                        break;
                                    }else if(j==listPhieuNVTDaDuyet.length-1){
                                        let decodeYear = decodeDatetime(listPhieuNVTFast[i]["ngay_ct"]);
                                        row = `
                                        <tr onclick="clickRow('${x}', this , 'table-data')" id="rows-${x+1}">
                                            <td><input type="checkbox" class="form-check-input row-check"/></td>
                                            <td class="row-time-ma-phieu" style="display:none">${listPhieuNVTFast[i]["ngay_ct"]}</td>
                                            <td style="display:none"><input class="check-box-export" type="checkbox"/></td>
                                            <td class="row-stt">${++x}</td>
                                            <td class="row-ma-phieu">
                                                <a class="ma-phieu" href="#" onclick="directChitiet('${listPhieuNVTFast[i]["stt_rec"]}', '${decodeYear}', '${listPhieuNVTFast[i]["u1"]}', ${x}, this, '${convertDateTimeDB(listPhieuNVTFast[i]["ngay_ct"])}')">
                                                    ${listPhieuNVTFast[i]["stt_rec"]} ${convertDateTime(listPhieuNVTFast[i]["ngay_ct"])}
                                                </a>
                                            </td>                                        
                                            <td class="row-ten-bp">${listPhieuNVTFast[i]["ten_bp"]}</td>
                                            <td class="row-dien-giai">
                                                <a class="dien-giai" onclick="directChitiet('${listPhieuNVTFast[i]["stt_rec"]}', '${decodeYear}', '${listPhieuNVTFast[i]["u1"]}', ${x}, this, '${convertDateTimeDB(listPhieuNVTFast[i]["ngay_ct"])}')" href="#">
                                                    ${listPhieuNVTFast[i]["dien_giai"]}
                                                </a>
                                            </td>
                                            <td class="nguoi-yeu-cau">${listPhieuNVTFast[i]["u1"]}</td>
                                            <td class="row-code-year" style="display:none">${decodeYear}</td>
                                        </tr>`;
                                        rows+=row;
                                    }
                                }
                            }else{
                                let decodeYear = decodeDatetime(listPhieuNVTFast[i]["ngay_ct"]);
                                row = `
                                <tr onclick="clickRow('${x}', this, 'table-data')" id="rows-${x+1}">
                                    <td><input type="checkbox" class="form-check-input row-check"/></td>
                                    <td class="row-time-ma-phieu" style="display:none">${listPhieuNVTFast[i]["ngay_ct"]}</td>
                                    <td style="display:none"><input class="check-box-export" type="checkbox"/></td>
                                    <td class="row-stt">${++x}</td>
                                    <td>
                                        <a class="ma-phieu" href="#" onclick="directChitiet('${listPhieuNVTFast[i]["stt_rec"]}', '${decodeYear}', '${listPhieuNVTFast[i]["u1"]}', ${x}, this, '${convertDateTimeDB(listPhieuNVTFast[i]["ngay_ct"])}')">
                                            ${listPhieuNVTFast[i]["stt_rec"]} ${convertDateTime(listPhieuNVTFast[i]["ngay_ct"])}
                                        </a>
                                    </td>
                                    <td class="row-ten-bp">${listPhieuNVTFast[i]["ten_bp"]}</td>
                                    <td class="row-dien-giai">
                                        <a class="dien-giai" onclick="directChitiet('${listPhieuNVTFast[i]["stt_rec"]}', '${decodeYear}', '${listPhieuNVTFast[i]["u1"]}', ${x},this, '${convertDateTimeDB(listPhieuNVTFast[i]["ngay_ct"])}')" href="#">
                                            ${listPhieuNVTFast[i]["dien_giai"]}
                                        </a>
                                    </td>
                                    <td class="nguoi-yeu-cau">${listPhieuNVTFast[i]["u1"]}</td>
                                    <td class="row-code-year" style="display:none">${decodeYear}</td>
                                </tr>`;
                                rows+=row;
                            }
                        }
                    }
                
                    $("#table-data tbody").html(rows);

                    let rowss = $("#table-data tbody tr");
                    for(let i=0; i<rowss.length; i++){
                        let filter = {};
                        filter.Id = i+1;
                        filter.DateDeNghi = $($("#table-data tbody tr .row-time-ma-phieu")[i]).text().trim();
                        filter.MaPhieu = $($("#table-data tbody tr .ma-phieu")[i]).text().trim().split(" ")[0];
                        filter.TenBoPhan = $($("#table-data tbody tr .row-ten-bp")[i]).text().trim();
                        filter.DienGiai = $($("#table-data tbody tr .dien-giai")[i]).text().trim();
                        filter.TenNguoiDeNghi = $($("#table-data tbody tr .nguoi-yeu-cau")[i]).text().trim();
                        filter.CodeYear = $($("#table-data tbody tr .row-code-year")[i]).text().trim();
                        filter.ListVatTuChangeSoLuong = [];
                        filter.CreatedAt = getCookie("id");
                        filter.UpdatedAt = getCookie("id");
                        filter.Status = $($("#table-data tbody tr .row-status")[i]).text().trim();

                        listFilter.push(filter);
                    }
                }
                let count = res.length;
                let totalPage = 0;
                if(count%10 != 0){
                    totalPages = Math.floor(count/10)+1;
                }else{
                    totalPages = Math.floor(count/10);
                }  
                importTable(listPhieuNVTDaDuyet, listPhieuNVTFast);
                // Cấu hình twbsPagination
                @* var options = {
                    totalPages: totalPages, // Tổng số trang
                    visiblePages: 5, // Số trang hiển thị trên thanh phân trang
                    onPageClick: function (event, page) {
                        let pag = +(page-1)*10;
                        let listResult = res.slice(pag, pag+10);
                        console.log(listResult);
                        importTable(listResult);
                }
                }
                // Áp dụng twbsPagination vào phần tử phân trang
                $('#pagination').twbsPagination(options); *@
            })
            .fail(err=>{
                console.log(err);
            });
        }
        initData(status, page);
        }
    </script>
</body>
<html>
